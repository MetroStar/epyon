# Approved Base Images Configuration
# ====================================
# This file defines the approved hardened container images for all security scans
# and deployments. Using Bitnami hardened containers for enhanced security.
#
# Benefits of Bitnami Hardened Containers:
# - Non-root by default
# - Regular security updates
# - Minimal attack surface
# - CIS benchmark compliance
# - No unnecessary packages
# - Consistent tagging and versioning
#
# Usage: Source this file in scanner scripts
#   source "$SCRIPT_DIR/../configuration/approved-base-images.conf"
#
# Last Updated: 2025-12-03

# ============================================
# APPROVED BITNAMI BASE IMAGES (STABLE VERSIONS)
# ============================================
# Using pinned stable versions instead of :latest for reproducibility
# and security compliance. Update versions after testing.

# Web Servers
APPROVED_NGINX="bitnami/nginx:1.27"
APPROVED_APACHE="bitnami/apache:2.4"

# Application Runtimes
APPROVED_NODE_18="bitnami/node:18"
APPROVED_NODE_20="bitnami/node:20"
APPROVED_NODE_22="bitnami/node:22"
APPROVED_PYTHON_311="bitnami/python:3.11"
APPROVED_PYTHON_312="bitnami/python:3.12"
APPROVED_JAVA_17="bitnami/java:17"
APPROVED_JAVA_21="bitnami/java:21"
APPROVED_GOLANG="bitnami/golang:1.23"
APPROVED_DOTNET="bitnami/dotnet-sdk:8"

# Databases
APPROVED_POSTGRESQL="bitnami/postgresql:16"
APPROVED_MYSQL="bitnami/mysql:8.0"
APPROVED_MONGODB="bitnami/mongodb:7.0"
APPROVED_REDIS="bitnami/redis:7.4"
APPROVED_MARIADB="bitnami/mariadb:11.4"
APPROVED_CASSANDRA="bitnami/cassandra:4.1"

# Message Queues
APPROVED_RABBITMQ="bitnami/rabbitmq:3.13"
APPROVED_KAFKA="bitnami/kafka:3.8"

# Search & Analytics
APPROVED_ELASTICSEARCH="bitnami/elasticsearch:8.15"
APPROVED_OPENSEARCH="bitnami/opensearch:2.17"

# Caching
APPROVED_MEMCACHED="bitnami/memcached:1.6"

# Kubernetes Tools
APPROVED_KUBECTL="bitnami/kubectl:1.31"
APPROVED_HELM="bitnami/helm:3.16"

# ============================================
# ARRAY OF ALL APPROVED IMAGES FOR SCANNING
# ============================================

# Core images to scan (most commonly used - reduced set for efficiency)
APPROVED_BASE_IMAGES=(
    "bitnami/nginx:1.27"
    "bitnami/node:22"
    "bitnami/python:3.12"
    "bitnami/postgresql:16"
)

# Extended images to scan (only when explicitly requested)
APPROVED_BASE_IMAGES_EXTENDED=(
    "bitnami/nginx:1.27"
    "bitnami/apache:2.4"
    "bitnami/node:18"
    "bitnami/node:20"
    "bitnami/node:22"
    "bitnami/python:3.11"
    "bitnami/python:3.12"
    "bitnami/java:17"
    "bitnami/java:21"
    "bitnami/golang:1.23"
    "bitnami/dotnet-sdk:8"
    "bitnami/postgresql:16"
    "bitnami/mysql:8.0"
    "bitnami/mongodb:7.0"
    "bitnami/redis:7.4"
    "bitnami/mariadb:11.4"
    "bitnami/cassandra:4.1"
    "bitnami/rabbitmq:3.13"
    "bitnami/kafka:3.8"
    "bitnami/elasticsearch:8.15"
    "bitnami/memcached:1.6"
    "bitnami/kubectl:1.31"
)

# ============================================
# HELPER FUNCTIONS
# ============================================

# Function to get all approved images as a space-separated string
get_approved_images() {
    echo "${APPROVED_BASE_IMAGES[@]}"
}

# Function to get extended approved images
get_approved_images_extended() {
    echo "${APPROVED_BASE_IMAGES_EXTENDED[@]}"
}

# Function to check if an image is approved
is_approved_image() {
    local image="$1"
    for approved in "${APPROVED_BASE_IMAGES_EXTENDED[@]}"; do
        if [[ "$image" == "$approved" ]] || [[ "$image" == bitnami/* ]]; then
            return 0
        fi
    done
    return 1
}

# Function to get recommended replacement for non-approved images
get_approved_replacement() {
    local image="$1"
    case "$image" in
        nginx:*|nginx)              echo "$APPROVED_NGINX" ;;
        node:18*|node:lts*)         echo "$APPROVED_NODE_18" ;;
        node:20*|node:latest*)      echo "$APPROVED_NODE_20" ;;
        python:3.11*|python:3.11)   echo "$APPROVED_PYTHON_311" ;;
        python:3.12*|python:latest) echo "$APPROVED_PYTHON_312" ;;
        postgres*|postgresql*)      echo "$APPROVED_POSTGRESQL" ;;
        mysql:*)                    echo "$APPROVED_MYSQL" ;;
        mongo*|mongodb*)            echo "$APPROVED_MONGODB" ;;
        redis:*)                    echo "$APPROVED_REDIS" ;;
        openjdk:17*|java:17*)       echo "$APPROVED_JAVA_17" ;;
        openjdk:21*|java:21*)       echo "$APPROVED_JAVA_21" ;;
        alpine:*|ubuntu:*|debian:*) echo "bitnami/minideb:latest" ;;
        *)                          echo "No approved replacement found" ;;
    esac
}

# Print approved images summary
print_approved_images() {
    echo "============================================"
    echo "Approved Bitnami Hardened Base Images"
    echo "============================================"
    echo ""
    echo "Web Servers:"
    echo "  • $APPROVED_NGINX"
    echo "  • $APPROVED_APACHE"
    echo ""
    echo "Application Runtimes:"
    echo "  • $APPROVED_NODE_18"
    echo "  • $APPROVED_NODE_20"
    echo "  • $APPROVED_PYTHON_311"
    echo "  • $APPROVED_PYTHON_312"
    echo "  • $APPROVED_JAVA_17"
    echo "  • $APPROVED_JAVA_21"
    echo ""
    echo "Databases:"
    echo "  • $APPROVED_POSTGRESQL"
    echo "  • $APPROVED_MYSQL"
    echo "  • $APPROVED_MONGODB"
    echo "  • $APPROVED_REDIS"
    echo ""
    echo "Message Queues:"
    echo "  • $APPROVED_RABBITMQ"
    echo "  • $APPROVED_KAFKA"
    echo ""
}
