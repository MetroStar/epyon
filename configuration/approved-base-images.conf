# Approved Base Images Configuration
# ====================================
# This file defines the approved hardened container images for all security scans
# and deployments. Using Bitnami hardened containers for enhanced security.
#
# ðŸ”’ SECURITY BEST PRACTICES:
# ---------------------------
# 1. ALWAYS pull latest images before scanning:
#    docker pull bitnami/node:latest
#
# 2. Check for updates weekly - Bitnami releases security patches frequently
#
# 3. Review scan results in: scans/<project>_<user>_<timestamp>/
#    - trivy/     - Container & filesystem vulnerabilities
#    - grype/     - Package vulnerabilities
#    - security-findings-summary.json - Consolidated high/critical findings
#
# 4. For production deployments, pin to specific patch versions after testing:
#    bitnami/node:24.13.0 (instead of :latest)
#
# 5. Monitor CVE databases:
#    - https://github.com/bitnami/containers/security/advisories
#    - https://nvd.nist.gov/
#
# Benefits of Bitnami Hardened Containers:
# - Non-root by default
# - Regular security updates
# - Minimal attack surface
# - CIS benchmark compliance
# - No unnecessary packages
# - Consistent tagging and versioning
#
# Usage: Source this file in scanner scripts
#   source "$SCRIPT_DIR/../configuration/approved-base-images.conf"
#
# Last Updated: 2026-01-14
#
# ============================================
# BUNDLED DEPENDENCIES & VULNERABILITY SOURCES
# ============================================
# Bitnami images bundle multiple components. Vulnerabilities may come from:
#
# bitnami/node:
#   - Node.js runtime (node-pkg)
#   - npm and bundled packages: glob, tar, semver, etc.
#   - Python runtime (for node-gyp builds)
#   - pip package manager
#   - System packages (photon OS)
#
# bitnami/nginx:
#   - NGINX web server
#   - OpenSSL/Go crypto libraries
#   - System packages (photon OS)
#
# bitnami/python:
#   - Python runtime
#   - pip package manager
#   - System packages (photon OS)
#
# bitnami/postgresql:
#   - PostgreSQL database
#   - System packages (photon OS)
#
# SCAN COVERAGE:
#   - Container image scans (Trivy/Grype): Scan ALL packages in the image
#   - Filesystem scans: Skip node_modules (local dev deps not shipped)
#   - SBOM scans: Generate full software bill of materials
#
# KNOWN VULNERABILITIES (as of 2026-01-14):
#   bitnami/node:latest (24.13.0) - Updated Jan 13, 2026
#   NOTE: Always pull latest images before scanning to get security patches
#   
#   Previously identified issues (may be patched in latest):
#   - CVE-2025-64756 (HIGH) - glob command injection (npm bundled)
#   - CVE-2025-64118 (MEDIUM) - node-tar race condition (npm bundled)
#   - CVE-2025-8869 (MEDIUM) - pip tar extraction (python bundled)
#   - CVE-2025-6075 (LOW) - python os.path.expandvars (python bundled)
#   
#   ACTION REQUIRED: Run 'docker pull bitnami/node:latest' regularly to get
#   the most recent security updates. Bitnami updates images frequently.

# ============================================
# APPROVED BITNAMI BASE IMAGES (STABLE VERSIONS)
# ============================================
# Using pinned stable versions instead of :latest for reproducibility
# and security compliance. Update versions after testing.

# Web Servers
APPROVED_NGINX="bitnami/nginx:1.27"
APPROVED_APACHE="bitnami/apache:2.4"

# Application Runtimes
# NOTE: Using :latest with Bitnami is acceptable as they maintain stability
# while providing security updates. For production, consider pinning to
# specific patch versions after testing (e.g., bitnami/node:24.13.0)
APPROVED_NODE_LATEST="bitnami/node:latest"  # Currently 24.13.0 (Jan 13, 2026)
APPROVED_NODE_20="bitnami/node:20"          # LTS version
APPROVED_NODE_18="bitnami/node:18"          # Older LTS (consider upgrading)
APPROVED_PYTHON_312="bitnami/python:3.12"   # Recommended
APPROVED_PYTHON_311="bitnami/python:3.11"   # Stable
APPROVED_JAVA_21="bitnami/java:21"          # Latest LTS
APPROVED_JAVA_17="bitnami/java:17"          # Previous LTS
APPROVED_GOLANG="bitnami/golang:1.23"       # Latest
APPROVED_DOTNET="bitnami/dotnet-sdk:8"      # .NET 8 LTS

# Databases
APPROVED_POSTGRESQL="bitnami/postgresql:16"
APPROVED_MYSQL="bitnami/mysql:8.0"
APPROVED_MONGODB="bitnami/mongodb:7.0"
APPROVED_REDIS="bitnami/redis:7.4"
APPROVED_MARIADB="bitnami/mariadb:11.4"
APPROVED_CASSANDRA="bitnami/cassandra:4.1"

# Message Queues
APPROVED_RABBITMQ="bitnami/rabbitmq:3.13"
APPROVED_KAFKA="bitnami/kafka:3.8"

# Search & Analytics
APPROVED_ELASTICSEARCH="bitnami/elasticsearch:8.15"
APPROVED_OPENSEARCH="bitnami/opensearch:2.17"

# Caching
APPROVED_MEMCACHED="bitnami/memcached:1.6"

# Kubernetes Tools
APPROVED_KUBECTL="bitnami/kubectl:1.31"
APPROVED_HELM="bitnami/helm:3.16"

# Docker Hardened Images (DHI) - Industry Standard with FIPS
APPROVED_DHI_CADDY="dhi/caddy:debian-13-2-fips-dev@sha256:ba86d16733750c6fd7b8866981016d2479e234c842d77413f1bf41c4404e555c"

# ============================================
# ARRAY OF ALL APPROVED IMAGES FOR SCANNING
# ============================================

# Core images to scan (most commonly used - reduced set for efficiency)
# IMPORTANT: Pull latest before each scan: docker pull bitnami/node:latest
APPROVED_BASE_IMAGES=(
    "dhi/caddy:debian-13-2-fips-dev@sha256:ba86d16733750c6fd7b8866981016d2479e234c842d77413f1bf41c4404e555c"  # DEFAULT - Docker Hardened with FIPS (baseline scans)
    "bitnami/node:latest"  # v24.13.0 as of 2026-01-14
)

# Extended images to scan (only when explicitly requested)
# Pull all images before scanning: for img in "${APPROVED_BASE_IMAGES_EXTENDED[@]}"; do docker pull "$img"; done
APPROVED_BASE_IMAGES_EXTENDED=(
    "bitnami/nginx:1.27"          # Latest stable
    "bitnami/apache:2.4"          # Latest stable
    "bitnami/node:latest"         # v24.13.0 - Most recent (RECOMMENDED)
    "bitnami/node:20"             # LTS
    "bitnami/node:18"             # Older LTS (EOL approaching)
    "bitnami/python:3.12"         # Latest stable
    "bitnami/python:3.11"         # Stable
    "bitnami/java:21"             # Latest LTS
    "bitnami/java:17"             # Previous LTS
    "bitnami/golang:1.23"         # Latest
    "bitnami/dotnet-sdk:8"        # .NET 8 LTS
    "bitnami/postgresql:16"       # Latest
    "bitnami/mysql:8.0"           # Latest 8.x
    "bitnami/mongodb:7.0"         # Latest
    "bitnami/redis:7.4"           # Latest 7.x
    "bitnami/mariadb:11.4"        # Latest
    "bitnami/cassandra:4.1"       # Latest 4.x
    "bitnami/rabbitmq:3.13"       # Latest
    "bitnami/kafka:3.8"           # Latest
    "bitnami/elasticsearch:8.15"  # Latest 8.x
    "bitnami/memcached:1.6"       # Latest
    "bitnami/kubectl:1.31"        # Latest K8s
)

# ============================================
# HELPER FUNCTIONS
# ============================================

# Function to get all approved images as a space-separated string
get_approved_images() {
    echo "${APPROVED_BASE_IMAGES[@]}"
}

# Function to get extended approved images
get_approved_images_extended() {
    echo "${APPROVED_BASE_IMAGES_EXTENDED[@]}"
}

# Function to validate that :latest tag is actually the latest version
validate_latest_image() {
    local image="$1"
    
    # Only validate :latest tags
    if [[ ! "$image" =~ :latest$ ]]; then
        return 0
    fi
    
    echo "ðŸ” Validating $image is up to date..."
    
    # Get local image digest
    local local_digest=$(docker image inspect "$image" --format='{{index .RepoDigests 0}}' 2>/dev/null | cut -d'@' -f2)
    
    if [ -z "$local_digest" ]; then
        echo "âš ï¸  Image not found locally, will pull latest"
        docker pull "$image" >/dev/null 2>&1
        return $?
    fi
    
    # Pull latest and check if digest changed
    echo "ðŸ“¥ Pulling latest version from registry..."
    docker pull "$image" >/dev/null 2>&1
    
    local new_digest=$(docker image inspect "$image" --format='{{index .RepoDigests 0}}' 2>/dev/null | cut -d'@' -f2)
    
    if [ "$local_digest" != "$new_digest" ]; then
        echo "âœ… Updated to latest version"
        echo "   Old: ${local_digest:0:19}..."
        echo "   New: ${new_digest:0:19}..."
        return 0
    else
        echo "âœ… Already at latest version ($local_digest)"
        return 0
    fi
}

# Function to check if an image is approved
is_approved_image() {
    local image="$1"
    for approved in "${APPROVED_BASE_IMAGES_EXTENDED[@]}"; do
        if [[ "$image" == "$approved" ]] || [[ "$image" == bitnami/* ]]; then
            return 0
        fi
    done
    return 1
}

# Function to get recommended replacement for non-approved images
get_approved_replacement() {
    local image="$1"
    case "$image" in
        nginx:*|nginx)              echo "$APPROVED_NGINX" ;;
        node:18*|node:lts*)         echo "$APPROVED_NODE_18" ;;
        node:20*|node:latest*)      echo "$APPROVED_NODE_20" ;;
        python:3.11*|python:3.11)   echo "$APPROVED_PYTHON_311" ;;
        python:3.12*|python:latest) echo "$APPROVED_PYTHON_312" ;;
        postgres*|postgresql*)      echo "$APPROVED_POSTGRESQL" ;;
        mysql:*)                    echo "$APPROVED_MYSQL" ;;
        mongo*|mongodb*)            echo "$APPROVED_MONGODB" ;;
        redis:*)                    echo "$APPROVED_REDIS" ;;
        openjdk:17*|java:17*)       echo "$APPROVED_JAVA_17" ;;
        openjdk:21*|java:21*)       echo "$APPROVED_JAVA_21" ;;
        alpine:*|ubuntu:*|debian:*) echo "bitnami/minideb:latest" ;;
        *)                          echo "No approved replacement found" ;;
    esac
}

# Print approved images summary
print_approved_images() {
    echo "============================================"
    echo "Approved Bitnami Hardened Base Images"
    echo "============================================"
    echo ""
    echo "Web Servers:"
    echo "  â€¢ $APPROVED_NGINX"
    echo "  â€¢ $APPROVED_APACHE"
    echo ""
    echo "Application Runtimes:"
    echo "  â€¢ $APPROVED_NODE_18"
    echo "  â€¢ $APPROVED_NODE_20"
    echo "  â€¢ $APPROVED_PYTHON_311"
    echo "  â€¢ $APPROVED_PYTHON_312"
    echo "  â€¢ $APPROVED_JAVA_17"
    echo "  â€¢ $APPROVED_JAVA_21"
    echo ""
    echo "Databases:"
    echo "  â€¢ $APPROVED_POSTGRESQL"
    echo "  â€¢ $APPROVED_MYSQL"
    echo "  â€¢ $APPROVED_MONGODB"
    echo "  â€¢ $APPROVED_REDIS"
    echo ""
    echo "Message Queues:"
    echo "  â€¢ $APPROVED_RABBITMQ"
    echo "  â€¢ $APPROVED_KAFKA"
    echo ""
}
